var N=Object.defineProperty,V=Object.defineProperties;var k=Object.getOwnPropertyDescriptors;var v=Object.getOwnPropertySymbols;var M=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable;var C=(e,t,a)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,_=(e,t)=>{for(var a in t||(t={}))M.call(t,a)&&C(e,a,t[a]);if(v)for(var a of v(t))j.call(t,a)&&C(e,a,t[a]);return e},L=(e,t)=>V(e,k(t));import{c5 as f,ao as G,f as d,c4 as p,ab as c,aU as h,aE as x,M as R,bM as g,a9 as m,N as U,ai as u,c6 as $,c7 as Y,R as B,bL as q,bj as z,bS as J,ak as T}from"./index-DzJUk-4s.js";import{h as Z}from"./querySelectorAll-CWDd-9ax.js";import{u as K}from"./index-B2h3DCGB.js";import{u as Q}from"./systemStore-CDAOEx2u.js";async function X(e){return G({url:"/preview/checkData",method:"get",params:e})}const tt=async e=>{const t=await f.keys(),a=[];for(t.forEach((o,s)=>{o[0]==="c"&&o.length===25&&e!==o&&a.push(o)});a.length>20;){const o=Math.floor(Math.random()*a.length);f.removeItem(a[o]),a.splice(o,1)}};async function et(e){const{data:t}=await X(e),a=await f.getItem(t.id);if(a&&(a==null?void 0:a.updateAt)===(t==null?void 0:t.updateAt))return tt(t.id),Promise.resolve({code:200,data:a});const o=await G({url:"/preview/getData",method:"get",params:e});return t.id&&o.data&&(o.data.updateAt=t.updateAt,await f.setItem(t.id,o.data)),o}const r=K(),b=Q(),lt=async()=>{var A;const e=d();let t="/wrapConfig.txt";[0].includes(1)&&(t=`${window.location.origin}/${window.location.pathname.replace(/\//g,"@")}.txt`);let o=!1;const s=await fetch(t);s.status===404&&u.push({path:"/error/404"});let i=await s.text();const l=R($(i));if(i=JSON.parse(l),i.trial&&(o=!0,F(i.trial)),i.logs&&(o=!0,F(i.trial)),i.type===1&&(i=await et({projectId:((A=i.data)==null?void 0:A.id)||e,infoId:b.userInfo.id}),i.data&&i.data.content&&(i.data.content=Y.decompress(i.data.content))),i&&i.code===B.SUCCESS){const{content:w,state:P,projectName:E,membership:O}=i.data;if(P!==1&&u.currentRoute.value.name!==q.CHART_EDIT_NAME&&!b.isRootUser){if(!at()&&!window.go_view_pro_isPreview)return{unRelease:!0,projectName:E||""};ot()}const W=_({},z(w));if(w){const{editCanvasConfig:S,requestGlobalConfig:D,componentList:I,theatreAnimationConfig:H,pageConfig:n}=W;r.editCanvasConfig=S,r.requestGlobalConfig=D,r.componentList=I,r.theatreAnimationConfig=H;let y=n;n!=null&&n.globalVarList&&(window.$globalVarList=n.globalVarList),n!=null&&n.globalFilterList&&(window.$globalFilterList=n.globalFilterList),(!n||!n.pageList.length)&&(r.addPageList(I,S),y=r.pageConfig),r.initPageConfig(L(_({},y),{activeIndex:0}))}if(r.projectInfo.projectName=E||"GoviewPro",J(E),O===0||o)return{watermark:!0}}else Z()},F=(e=0)=>{const a=new Date().getTime()-e;if(a<0||a>3600*1e3)u.push({name:T.ERROR_PAGE_NAME_TEMPORARY});else{const o=36e5-a;setTimeout(()=>{u.push({path:T.ERROR_PAGE_NAME_TEMPORARY})},o)}},at=()=>{const e=d(),t=p(c.GO_CHART_PREVIEW_FLAG);return h(t)&&x(e)&&t.find(a=>R(a)===e)},dt=()=>{const e=d(),t=p(c.GO_CHART_PREVIEW_PASSWORD_FLAG);return h(t)&&x(e)&&t.find(a=>R(a)===e)},ot=()=>{const e=d(),t=p(c.GO_CHART_PREVIEW_FLAG);e&&h(t)?g(c.GO_CHART_PREVIEW_FLAG,[...t,m(e)]):e&&g(c.GO_CHART_PREVIEW_FLAG,[m(e)])},ft=()=>{const e=d(),t=p(c.GO_CHART_PREVIEW_PASSWORD_FLAG);e&&h(t)?g(c.GO_CHART_PREVIEW_PASSWORD_FLAG,[...t,m(e)]):e&&g(c.GO_CHART_PREVIEW_PASSWORD_FLAG,[m(e)])},gt=e=>{setInterval(()=>{const t=document.getElementById("go-edit-watermark");if(t)t.style.zIndex="9999",t.style.position="fixed",t.style.top="0",t.style.width=e.width||"100vw",t.style.height=e.height||"100vh",t.style.pointerEvents="none";else{const a=document.createElement("canvas");a.width=document.body.clientWidth,a.height=document.body.clientHeight;const o=a.getContext("2d");if(o){o.font="20px Microsoft Yahei",o.fillStyle="rgba(128, 128, 128, .3)",o.rotate(-10*Math.PI/180);for(let i=0;i<document.body.clientHeight/200;i++)for(let l=0;l<document.body.clientWidth/200;l++)o.fillText(U,l*200,i*200);const s=new Image;s.id="go-edit-watermark",s.src=a.toDataURL(),s.style.zIndex="9999",s.style.position="fixed",s.style.top="0",s.style.width="100vw",s.style.height="100vh",s.style.pointerEvents="none",s.style.pointerEvents="none",document.body.appendChild(s)}}},1e4)};export{gt as a,dt as c,lt as g,ft as s};
