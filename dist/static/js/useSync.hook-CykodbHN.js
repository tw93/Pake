var gt=Object.defineProperty,ft=Object.defineProperties;var lt=Object.getOwnPropertyDescriptors;var _=Object.getOwnPropertySymbols;var W=Object.prototype.hasOwnProperty,z=Object.prototype.propertyIsEnumerable;var j=(t,n,C)=>n in t?gt(t,n,{enumerable:!0,configurable:!0,writable:!0,value:C}):t[n]=C,b=(t,n)=>{for(var C in n||(n={}))W.call(n,C)&&j(t,C,n[C]);if(_)for(var C of _(n))z.call(n,C)&&j(t,C,n[C]);return t},w=(t,n)=>ft(t,lt(n));var $=t=>typeof t=="symbol"?t:t+"",X=(t,n)=>{var C={};for(var c in t)W.call(t,c)&&n.indexOf(c)<0&&(C[c]=t[c]);if(t!=null&&_)for(var c of _(t))n.indexOf(c)<0&&z.call(t,c)&&(C[c]=t[c]);return C};import{f as U,bR as O,b2 as D,cI as Ct,cJ as dt,R as Z,cx as Q,bu as F,eU as mt,ae as ut,cA as Et,c7 as pt,b_ as ht,bj as St,aP as Tt,aO as yt,ak as Lt,D as At,E as H,b8 as Y,bk as Pt,bl as vt,aa as G,cG as It,aw as ot,eV as Ot,eW as Rt,eX as bt,eN as k}from"./index-DzJUk-4s.js";import{u as nt,m as wt,t as Ut,E as P,P as S,$ as R,b as v,q as tt,C as I,T as Ft,g as et,f as _t,p as kt}from"./index-B2h3DCGB.js";import{a as Ht,u as Mt,h as $t}from"./querySelectorAll-CWDd-9ax.js";import{u as Dt}from"./systemStore-CDAOEx2u.js";import{a as Gt,l as at,b as Vt}from"./plugin-BZaVEG5Y.js";import{b as Nt}from"./file-BoGdIhh5.js";const M=At(),Bt=t=>t;M.on(H.CHART_EDIT_COMPONENT_LOADED,()=>{const t=nt();ot(()=>{const n=t.getStorageInfo();(!n.pageConfig||!n.pageConfig.pageList.length)&&(t.addPageList(n.componentList,n.editCanvasConfig),n.pageConfig=t.pageConfig)})});const L=(t,n,C=!1)=>{if(bt(t,n),!n)return k(t,n);if(C)return k(t,n);const c=n.option;if(!c)return k(t,n);if(n.option=void 0,c)return w(b({},k(t,n)),{option:c})},Zt=()=>{const t=nt(),n=wt(),C=Dt(),c=Ht(),V=async(a,e=!1,r=!1)=>{var E,s;try{if(e&&t.initFirstPageConfig(a.pageConfig),(E=a.pageConfig)!=null&&E.globalVarList){let i=0;const p=Y(t.getVarList);a.pageConfig.globalVarList.forEach(g=>{p.some(o=>o.name===g.name)?i++:t.getVarList.push(g)}),i&&setTimeout(()=>{window.$message.error(`由于名称冲突，${i}个全局变量导入失败，请手动创建变量！`,{duration:5e3})},500)}if((s=a.pageConfig)!=null&&s.globalFilterList){let i=0;const p=Y(t.getFilterList);a.pageConfig.globalFilterList.forEach(g=>{p.some(o=>o.name===g.name)?i++:t.getFilterList.push(g)}),i&&setTimeout(()=>{window.$message.error(`由于名称冲突，${i}个全局过滤器导入失败，请手动创建！`,{duration:5e3})},500)}e||(a.pageConfig&&a.pageConfig.pageList&&a.pageConfig.pageList.length?a.pageConfig.pageList.forEach(i=>{t.addPageList(i.componentList,i.editCanvasConfig)}):a.componentList&&a.editCanvasConfig&&t.addPageList(a.componentList,a.editCanvasConfig)),(!a.pageConfig||!a.pageConfig.pageList.length)&&(e&&(!t.pageConfig||!t.pageConfig.pageList.length?t.addPageList(a.componentList,a.editCanvasConfig):(t.componentList=a.componentList,t.editCanvasConfig=a.editCanvasConfig,t.saveCurrentPage())),a.pageConfig=t.pageConfig),e&&(t.componentList=[],n.clearBackStack(),n.clearForwardStack());let l=0,d=0;a.pageConfig.pageList.forEach(i=>{d=d+i.componentList.length});const m=(i,p)=>{const g={[v.EDIT_CANVAS_CONFIG]:{},[v.COMPONENT_LIST]:[]};i.editCanvasConfig=Bt(i.editCanvasConfig);for(const o of i.componentList){const h=f=>{f.chartConfig.chartFrame===F.REMOTE||f.chartConfig.chartFrame===F.THREE_MODEL||window.$vue.component(f.chartConfig.chartKey)||(window.$vue.component(f.chartConfig.chartKey,_t(f.chartConfig)),window.$vue.component(f.chartConfig.conKey,kt(f.chartConfig)))};if(o.isGroup)for(const f of o.groupList)h(f);else h(o)}const T=(o,h)=>{var y;let f=null;o.chartConfig.chartFrame===F.REMOTE?f=Pt(o.chartConfig):o.chartConfig.chartFrame===F.THREE_MODEL?f=vt(o.chartConfig):(o.chartConfig.chartKey==="VImage"&&(o.chartConfig.image=D((y=o.option)==null?void 0:y.dataset)),f=tt(o.chartConfig)),o.chartConfig.redirectComponent&&(o.chartConfig.dataset&&(f.option.dataset=o.chartConfig.dataset),f.chartConfig.title=o.chartConfig.title,f.chartConfig.chartFrame=o.chartConfig.chartFrame),h?h(r?L(f,w(b({},o),{id:G()})):L(f,o)):r?g.componentList.push(L(f,w(b({},o),{id:G()}))):g.componentList.push(L(f,o))};for(const o in i)if(o===v.COMPONENT_LIST){for(const h of i[o]){let f=parseInt((parseFloat(`${++l/d}`)*100).toString());if(c.setItemUnHandle(I.PERCENTAGE,f),h.isGroup){let y=new It;r?y=L(y,w(b({},h),{id:G()})):y=L(y,h);const K=[];for(const rt of h.groupList)T(rt,ct=>{K.push(ct)});y.groupList=K,g.componentList.push(y)}else T(h);f===100&&(n.clearBackStack(),n.clearForwardStack(),ot(()=>{M.emit(H.CHART_EDIT_COMPONENT_LOADED)}))}d||M.emit(H.CHART_EDIT_COMPONENT_LOADED)}else o===v.EDIT_CANVAS_CONFIG&&L(g.editCanvasConfig,i[o],!0);return g},u=a.pageConfig.pageList;Ot(a.pageConfig,t.pageConfig),e&&(t.initPageConfig(a.pageConfig),await t.initPageFunction(a.pageConfig)),u.forEach((i,p)=>{const g=m(i,p);u[p][v.COMPONENT_LIST]=g.componentList,u[p][v.EDIT_CANVAS_CONFIG]=g.editCanvasConfig}),e&&(L(t.requestGlobalConfig,a.requestGlobalConfig,!0),L(t.theatreAnimationConfig,a.theatreAnimationConfig,!0),t.initPageConfig(a.pageConfig)),c.setItemUnHandle(I.PERCENTAGE,0)}catch(l){console.log(l),c.setItemUnHandle(I.PERCENTAGE,0),window.$message.error("导入失败，请检查文件是否损坏！")}},N=(a,e)=>{const{id:r,projectName:E,remarks:s,thumbnail:l,state:d,createUserId:m,isTeamCreator:u,roleStatus:i,teamRoleStatus:p,createdAt:g,updateAt:T}=a;if(t.setProjectInfo(S.PROJECT_ID,r),t.setProjectInfo(S.PROJECT_NAME,E),t.setProjectInfo(S.REMARKS,s),t.setProjectInfo(S.THUMBNAIL,l),t.setProjectInfo(S.RELEASE,d===1),t.setProjectInfo(S.CREATE_USER_ID,m),t.setProjectInfo(S.IS_TEAM_CREATOR,u),t.setProjectInfo(S.ROLE_STATUS,i),t.setProjectInfo(S.TEAM_ROLE_STATUS,p),t.setProjectInfo(S.CREATE_AT,g),t.setProjectInfo(S.UPDATE_AT,T),!e)return;const{requestGlobalConfig:o}=e;t.requestGlobalConfig=o},it=async()=>{var a;t.componentList=[],t.setEditCanvas(P.SAVE_STATUS,O.START);try{c.setItemUnHandle(I.FETCH_DATA,R.FETCH),Mt();const e=await Et({projectId:U()});if((a=e==null?void 0:e.data)!=null&&a.content&&(e.data.content=pt.decompress(e.data.content),e.data.content.startsWith("http"))){window.OSSProjectURL=e.data.content;try{e.data.content=(await ht.get(e.data.content,{responseType:"text"})).data}catch(r){e.data.content="",setTimeout(()=>{c.fetchData=R.ERROR,c.setItemUnHandle(I.FETCH_DATA,R.ERROR)},0)}}if(c.setItemUnHandle(I.FETCH_DATA,R.SUCCESS),e&&e.code===Z.SUCCESS){if(e.data){t.setEditCanvas(P.SAVE_STATUS,O.SUCCESS);const r=St(e.data.content);if(N(e.data,r),!e.data.isTeamCreator&&e.data.createUserId!==C.getUserInfo.id&&e.data.teamRoleStatus!==Ft.MANAGE&&e.data.roleStatus!==et.MANAGE&&e.data.roleStatus!==et.EDIT){window.$message.error("您没有权限编辑该大屏！"),Tt(yt(Lt.PROJECT_NAME,"href"));return}e.data.content?V(r,!0):(M.emit(H.CHART_EDIT_COMPONENT_LOADED),c.setItemUnHandle(I.PERCENTAGE,100));return}else t.setProjectInfo(S.PROJECT_ID,U());setTimeout(()=>{t.setEditCanvas(P.SAVE_STATUS,O.SUCCESS)},0);return}else c.setItemUnHandle(I.FETCH_DATA,R.ERROR)}catch(e){console.log(e),t.setEditCanvas(P.SAVE_STATUS,O.FAILURE),$t()}},B=a=>{var r;const e=[];for(let E=0;E<a.length;E++){const s=a[E];if(s.request.requestUrl&&s.chartConfig.chartFrame===F.ECHARTS){const l=tt(s.chartConfig);(r=l==null?void 0:l.option)!=null&&r.dataset&&(s.option.dataset=l==null?void 0:l.option.dataset)}s.groupList&&s.groupList.length>0&&(s.groupList=B(s.groupList)),e.push(s)}return e},q=async a=>{const e=document.getElementById("go-edit-watermark");try{const r=document.querySelector(".go-edit-range");e&&(e.style.display="block");const E=await Rt(r,{backgroundColor:null,allowTaint:!0,useCORS:!0,onclone:u=>{const i=u.querySelector(".go-edit-range");i&&(i.style.transform="scale(1)"),u.querySelectorAll(".n-gradient-text").forEach(g=>{g.style.backgroundImage="linear-gradient(45deg, rgba(0, 0, 0, 0) 0%, rgb(0, 0, 0, 0) 100%)",g.style.color="#fff"})}});e&&(e.style.display="none");const s=`thumbnail_${U()}.png`,l=`thumbnail/${s}`;(await(await C.getSTSClient()).putObject({key:l,body:Nt(E.toDataURL(),s)})).statusCode===200&&Q({projectId:a,fileKey:l}).then(i=>{console.log("更新预览图成功"),A(!1)})}catch(r){e&&(e.style.display="none"),A(!1),console.log(r)}};function A(a){let e=document.getElementById("overlayDom");e||(e=document.createElement("div"),e.id="overlayDom",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.zIndex="9999999",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.display="none",document.body.appendChild(e)),a?e.style.display="block":e.style.display="none"}const st=async a=>{const e=document.getElementById("go-edit-watermark");try{if(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia||!window.ImageCapture){q(a);return}A(!0);const r=document.querySelector("#go-chart-edit-content");e&&(e.style.display="block");const E=await navigator.mediaDevices.getDisplayMedia({preferCurrentTab:!0}),[s]=E.getVideoTracks();if(window.CropTarget&&s.cropTo&&r){const u=await CropTarget.fromElement(r);await s.cropTo(u)}const l=new ImageCapture(s);window.$message.destroyAll();const d=await l.grabFrame(),m=document.createElement("canvas");m.width=d.width,m.height=d.height,m.getContext("2d").drawImage(d,0,0),m.toBlob(async u=>{s.stop(),A(!1),e&&(e.style.display="none");const i=`thumbnail_${U()}.png`,p=`thumbnail/${i}`;let g=new File([u],i,{type:"image/jpeg"});(await(await C.getSTSClient()).putObject({key:p,body:g})).statusCode===200&&Q({projectId:a,fileKey:p}).then(f=>{console.log("更新预览图成功")})})}catch(r){e&&(e.style.display="none"),q(a),A(!1)}},x=()=>{try{const a=window.$TheatreStudio;let e=a.createContentOfSaveFile(a.projectId);if(e=D(e),e.sheetsById.组件){const r={};t.getPageList.forEach(d=>{d.componentList.forEach(m=>{r[m.id]=m,m.groupList&&m.groupList.length>0&&m.groupList.forEach(u=>{r[u.id]=u})})});const s=e.sheetsById.组件.sequence,l=e.sheetsById.组件.staticOverrides;if(s&&s.tracksByObject)for(const d in s.tracksByObject)r[d]||delete s.tracksByObject[d];if(l&&l.byObject)for(const d in l.byObject)r[d]||delete l.byObject[d];e.revisionHistory=[e.revisionHistory[0]]}t.setTheatreAnimationConfig(e)}catch(a){console.error(a)}},J=Ut(async(a=!0,e=!1)=>{var i,p,T;if(t.getEditCanvas[P.IS_DRAG])return;if(!U()){window.$message.error("保存失败，请关闭页面重新打开！");return}let E=t.getProjectInfo[S.PROJECT_ID];if(E===null||E===""||c.getFetchData!==R.SUCCESS){window.$message.error("数据初未始化成功,请刷新页面！");return}Gt(),A(!0);try{window.$TheatreStudio.sheet.sequence.position=0,window.$TheatreStudio.pause(!1),await new Promise(o=>setTimeout(o,0))}catch(o){}t.saveCurrentPage(),x(),t.setEditCanvas(P.SAVE_STATUS,O.START),a&&st(E);const s=t.getStorageInfo();if(!s){window.$message.error("保存失败，请导出文件备份，并刷新重试！"),at();return}s.pageConfig.pageList.map(o=>{o.componentList=B(D(o.componentList))});const g=s,{[i=v.COMPONENT_LIST]:l,[p=v.EDIT_CANVAS_CONFIG]:d}=g,m=X(g,[$(i),$(p)]),u=await Ct({projectId:E,projectName:t.projectInfo.projectName,content:dt(m||{})});if(u&&u.code===Z.SUCCESS){t.setEditCanvas(P.SAVE_STATUS,O.SUCCESS),Vt(),a||A(!1),e&&(window.$message.success("保存成功！"),(T=window==null?void 0:window.$TheatreStudio)==null||T.play(!1));return}at(),A(!1),t.setEditCanvas(P.SAVE_STATUS,O.FAILURE)},3e3);return{dataSyncUpdate:J,updateStoreInfo:N,updateComponent:V,dataSyncFetch:it,intervalDataSyncUpdate:()=>{const a=setInterval(()=>{J()},mt*1e3);ut(()=>{clearInterval(a)})},saveTheatreConfig:x}};export{Zt as u};
